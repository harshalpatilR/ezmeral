{"data":{"edges":[],"nodes":[{"data":{"id":"PythonREPLComponent-7Oan5","type":"PythonREPLComponent","node":{"template":{"_type":"Component","code":{"type":"code","required":true,"placeholder":"","list":false,"show":true,"multiline":true,"value":"import importlib\nimport subprocess\nimport sys\nfrom langchain_experimental.utilities import PythonREPL\nfrom langflow.custom import Component\nfrom langflow.io import CodeInput, Output, StrInput, SecretStrInput\nfrom langflow.schema import Data\n\nclass PythonREPLComponent(Component):\n    display_name = \"Python REPL\"\n    description = (\n        \"A Python code executor that lets you run Python code with specific imported modules. \"\n        \"Remember to always use print() to see your results. Example: print(df.head())\"\n    )\n    icon = \"Python\"\n    inputs = [\n        StrInput(\n            name=\"global_imports\",\n            display_name=\"Global Imports\",\n            info=\"A comma-separated list of modules to import globally, e.g. 'math,numpy,pandas,prestodb'.\",\n            value=\"math,pandas\",\n            required=True,\n        ),\n        CodeInput(\n            name=\"python_code\",\n            display_name=\"Python Code\",\n            info=\"The Python code to execute. Only modules specified in Global Imports can be used.\",\n            value=\"print('Hello, World!')\",\n            input_types=[\"Message\"],\n            tool_mode=True,\n            required=True,\n        ),\n        StrInput(\n            name=\"sql_query\",\n            display_name=\"SQL Query\",\n            info=\"SQL query to execute against Presto\",\n            value=\"\",\n            input_types=[\"Message\"],\n            required=False,\n        ),\n        SecretStrInput(\n            name=\"jwt_token\",\n            display_name=\"JWT Token\",\n            info=\"JWT token for Presto authentication\",\n            value=\"\",\n            required=False,\n        ),\n        SecretStrInput(\n            name=\"refresh_token\",\n            display_name=\"Refresh Token\",\n            info=\"Refresh token for Presto authentication\",\n            value=\"\",\n            required=False,\n        ),\n        SecretStrInput(\n            name=\"secret_token\",\n            display_name=\"Secret Token\",\n            info=\"Secret token for Presto authentication\",\n            value=\"\",\n            required=False,\n        ),\n        StrInput(\n            name=\"uadomain\",\n            display_name=\"Domain for this AIE\",\n            info=\"Domain of this instance\",\n            value=\"\",\n            required=False,\n        ),\n        StrInput(\n            name=\"presto_catalog\",\n            display_name=\"Presto Catalog\",\n            info=\"Presto catalog name\",\n            value=\"finance\",\n            required=False,\n        ),\n        StrInput(\n            name=\"presto_schema\",\n            display_name=\"Presto Schema\",\n            info=\"Presto schema name\",\n            value=\"banking\",\n            required=False,\n        ),\n        StrInput(\n            name=\"presto_user\",\n            display_name=\"Presto User\",\n            info=\"Presto user name\",\n            value=\"admin\",\n            required=False,\n        ),\n    ]\n    outputs = [\n        Output(\n            display_name=\"Results\",\n            name=\"results\",\n            type_=Data,\n            method=\"run_python_repl\",\n        ),\n    ]\n\n    def install_package(self, package_name: str) -> bool:\n        \"\"\"Install a package using pip if it's not already installed.\"\"\"\n        try:\n            self.log(f\"Attempting to install package: {package_name}\")\n            subprocess.check_call([\n                \"pip3\", \"install\", \"--user\", \"presto-python-client\"\n            ])\n            self.log(f\"Successfully installed presto-python-client\")\n            return True\n        except subprocess.CalledProcessError as e:\n            self.log(f\"Failed to install presto-python-client: {e}\")\n            return False\n\n    def get_globals(self, global_imports: str | list[str]) -> dict:\n        \"\"\"Create a globals dictionary with only the specified allowed imports.\"\"\"\n        global_dict = {}\n        try:\n            if isinstance(global_imports, str):\n                modules = [module.strip() for module in global_imports.split(\",\")]\n            elif isinstance(global_imports, list):\n                modules = global_imports\n            else:\n                msg = \"global_imports must be either a string or a list\"\n                raise TypeError(msg)\n            \n            for module in modules:\n                try:\n                    imported_module = importlib.import_module(module)\n                    global_dict[imported_module.__name__] = imported_module\n                except ImportError as e:\n                    if module == \"prestodb\":\n                        self.log(f\"Module {module} not found, attempting to install presto-python-client...\")\n                        \n                        # Try to install the package\n                        if self.install_package(module):\n                            try:\n                                # Try importing again after installation\n                                imported_module = importlib.import_module(module)\n                                global_dict[imported_module.__name__] = imported_module\n                                self.log(f\"Successfully imported {module} after installation\")\n                            except ImportError as retry_e:\n                                msg = f\"Could not import module {module} even after installation: {retry_e!s}\"\n                                raise ImportError(msg) from retry_e\n                        else:\n                            msg = f\"Could not install or import module {module}: {e!s}\"\n                            raise ImportError(msg) from e\n                    else:\n                        msg = f\"Could not import module {module}: {e!s}\"\n                        raise ImportError(msg) from e\n                        \n        except Exception as e:\n            self.log(f\"Error in global imports: {e!s}\")\n            raise\n        else:\n            self.log(f\"Successfully imported modules: {list(global_dict.keys())}\")\n            return global_dict\n\n    def run_python_repl(self) -> Data:\n        try:\n            # Extract text from Message object if needed (for python_code)\n            if hasattr(self.python_code, 'text'):\n                code_to_execute = self.python_code.text\n            elif hasattr(self.python_code, 'content'):\n                code_to_execute = self.python_code.content\n            elif isinstance(self.python_code, str):\n                code_to_execute = self.python_code\n            else:\n                code_to_execute = str(self.python_code)\n            \n            # Extract SQL query from the new input\n            if hasattr(self.sql_query, 'text'):\n                sql_to_execute = self.sql_query.text\n            elif hasattr(self.sql_query, 'content'):\n                sql_to_execute = self.sql_query.content\n            elif isinstance(self.sql_query, str):\n                sql_to_execute = self.sql_query\n            else:\n                sql_to_execute = str(self.sql_query)\n            \n            # Extract token and Presto configuration\n            jwt_token = self.jwt_token if self.jwt_token else \"\"\n            refresh_token = self.refresh_token\n            secret_token = self.secret_token\n            presto_catalog = self.presto_catalog if self.presto_catalog else \"finance\"\n            presto_schema = self.presto_schema if self.presto_schema else \"banking\"\n            presto_user = self.presto_user if self.presto_user else \"admin\"\n            uadomain = self.uadomain\n            \n            self.log(f\"SQL to execute: {sql_to_execute}\")\n            self.log(f\"Code to execute: {code_to_execute[:100]}...\")\n            self.log(f\"JWT token provided: {'Yes' if jwt_token else 'No'}\")\n            self.log(f\"Refresh token provided: {'Yes' if refresh_token else 'No'}\")\n            self.log(f\"Secret token provided: {'Yes' if secret_token else 'No'}\")\n            self.log(f\"Domain provided: {'Yes' if uadomain else 'No'}\")\n            self.log(f\"Presto config - Catalog: {presto_catalog}, Schema: {presto_schema}, User: {presto_user}\")\n            \n            \n            globals_ = self.get_globals(self.global_imports)\n            globals_['sql_query'] = sql_to_execute  # Make SQL available to Python code\n            globals_['jwt_token'] = jwt_token  # Make JWT token available to Python code\n            globals_['secret_token'] = secret_token \n            globals_['refresh_token'] = refresh_token\n            globals_['uadomain'] = uadomain\n            globals_['presto_catalog'] = presto_catalog  # Make catalog available\n            globals_['presto_schema'] = presto_schema  # Make schema available\n            globals_['presto_user'] = presto_user  # Make user available\n            \n            python_repl = PythonREPL(_globals=globals_)\n            result = python_repl.run(code_to_execute)\n            self.log(result)\n            result = result.strip() if result else \"\"\n            self.log(\"Code execution completed successfully\")\n            return Data(data={\"result\": result})\n        except ImportError as e:\n            error_message = f\"Import Error: {e!s}\"\n            self.log(error_message)\n            return Data(data={\"error\": error_message})\n        except SyntaxError as e:\n            error_message = f\"Syntax Error: {e!s}\"\n            self.log(error_message)\n            return Data(data={\"error\": error_message})\n        except (NameError, TypeError, ValueError) as e:\n            error_message = f\"Error during execution: {e!s}\"\n            self.log(error_message)\n            return Data(data={\"error\": error_message})\n\n    def build(self):\n        return self.run_python_repl","fileTypes":[],"file_path":"","password":false,"name":"code","advanced":true,"dynamic":true,"info":"","load_from_db":false,"title_case":false},"global_imports":{"tool_mode":false,"trace_as_metadata":true,"load_from_db":false,"list":false,"list_add_label":"Add More","required":true,"placeholder":"","show":true,"name":"global_imports","value":"requests,json,time,urllib3,os","display_name":"Global Imports","advanced":false,"dynamic":false,"info":"A comma-separated list of modules to import globally, e.g. 'math,numpy,pandas,prestodb'.","title_case":false,"type":"str","_input_type":"StrInput"},"jwt_token":{"load_from_db":false,"required":false,"placeholder":"","show":true,"name":"jwt_token","value":"","display_name":"JWT Token","advanced":false,"input_types":[],"dynamic":false,"info":"JWT token for Presto authentication","title_case":false,"password":true,"type":"str","_input_type":"SecretStrInput"},"presto_catalog":{"tool_mode":false,"trace_as_metadata":true,"load_from_db":false,"list":false,"list_add_label":"Add More","required":false,"placeholder":"","show":true,"name":"presto_catalog","value":"retail","display_name":"Presto Catalog","advanced":false,"dynamic":false,"info":"Presto catalog name","title_case":false,"type":"str","_input_type":"StrInput"},"presto_schema":{"tool_mode":false,"trace_as_metadata":true,"load_from_db":false,"list":false,"list_add_label":"Add More","required":false,"placeholder":"","show":true,"name":"presto_schema","value":"default","display_name":"Presto Schema","advanced":false,"dynamic":false,"info":"Presto schema name","title_case":false,"type":"str","_input_type":"StrInput"},"presto_user":{"tool_mode":false,"trace_as_metadata":true,"load_from_db":false,"list":false,"list_add_label":"Add More","required":false,"placeholder":"","show":true,"name":"presto_user","value":"admin","display_name":"Presto User","advanced":false,"dynamic":false,"info":"Presto user name","title_case":false,"type":"str","_input_type":"StrInput"},"python_code":{"tool_mode":true,"trace_as_input":true,"list":false,"list_add_label":"Add More","required":true,"placeholder":"","show":true,"name":"python_code","value":"import requests\nimport json\nimport time\nimport urllib3\nimport os\n\n\n# Disable SSL warnings\nurllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)\n\n# refresh token for each call\ndef get_token(refresh_token, secret_token, uadomain):\n    UA_DOMAIN= uadomain\n    KC_ADDR=f\"keycloak.{UA_DOMAIN}\"\n\n    payload_refresh = {\n        \"grant_type\": \"refresh_token\",\n        \"client_id\": \"ua\",\n        \"refresh_token\": refresh_token,\n        \"client_secret\": secret_token\n    }\n    # ignore certs\n    results = requests.post(f\"https://{KC_ADDR}/realms/UA/protocol/openid-connect/token\", data=payload_refresh, verify=False)\n    #print(results)\n    ACCESS_TOKEN = results.json()['access_token']\n    #print(ACCESS_TOKEN)\n    return(ACCESS_TOKEN)\n\n\ndef query_prestodb(sql_query):\n    # Use the variables passed from the component\n    token = jwt_token #if jwt_token else \"default_token_here\"\n    catalog = presto_catalog #if presto_catalog else \"finance\"\n    schema = presto_schema #if presto_schema else \"banking\"\n    user = presto_user if presto_user else \"admin\"\n    \n    #print(\"SQL\")\n    #print(sql_query)\n    #print(\"token\")\n    #print(token)\n    #print(\"ENV: refresh token\")\n    #print(refresh_token)\n    #print(\"ENV: secret token\")\n    #print(secret_token)\n    \n    if(secret_token and refresh_token):\n        #token = get_token(refresh_token, secret_token, uadomain)\n        UA_DOMAIN= uadomain\n        KC_ADDR=f\"keycloak.{UA_DOMAIN}\"\n\n        payload_refresh = {\n            \"grant_type\": \"refresh_token\",\n            \"client_id\": \"ua\",\n            \"refresh_token\": refresh_token,\n            \"client_secret\": secret_token\n        }\n        # ignore certs\n        results = requests.post(f\"https://{KC_ADDR}/realms/UA/protocol/openid-connect/token\", data=payload_refresh, verify=False)\n        print(f\"token request: {results}\",results)\n        token = results.json()['access_token']\n        print(token)\n    \n    # Submit query\n    response = requests.post(\n        'https://ezpresto-sts-mst-0.ezpresto-svc-hdl.ezpresto.svc.cluster.local:8081/v1/statement',\n        headers={\n            'Authorization': f'Bearer {token}',\n            'X-Presto-Catalog': catalog,\n            'X-Presto-Schema': schema,\n            'X-Presto-User': user,\n            'Content-Type': 'text/plain'\n        },\n        data=sql_query,\n        verify=False\n    )\n    \n    \n    print(\"RESPONSE\")\n    print(response)\n    \n    \n    parsed_response = response.json()\n    \n    # Check for errors in the initial response\n    if 'error' in parsed_response:\n        print(f\"Received Response: {response}\" )\n        print(f\"Query error: {parsed_response['error']}\")\n        return {'error': parsed_response['error'], 'columns': [], 'data': [], 'row_count': 0}\n    \n    attempts = 0\n    max_attempts = 10\n    all_data = []\n    \n    # Poll for results\n    while parsed_response.get('nextUri') and attempts < max_attempts:\n        time.sleep(0.5)  # Wait 500ms\n        \n        results_response = requests.get(\n            parsed_response['nextUri'],\n            headers={\n                'Authorization': f'Bearer {token}',\n                'X-Presto-User': user\n            },\n            verify=False\n        )\n        \n        parsed_response = results_response.json()\n        \n        # Check for errors in polling responses\n        if 'error' in parsed_response:\n            print(f\"Polling error: {parsed_response['error']}\")\n            break\n        \n        # Collect data if available\n        if 'data' in parsed_response:\n            all_data.extend(parsed_response['data'])\n        \n        attempts += 1\n    \n    return {\n        'columns': parsed_response.get('columns', []),\n        'data': all_data,\n        'row_count': len(all_data),\n        'final_state': parsed_response.get('stats', {}).get('state', 'unknown')\n    }\n\n# Execute query\ntry:\n    result = query_prestodb(sql_query)\n    \n    print(f\"Query completed successfully!\")\n    print(f\"State: {result['final_state']}\")\n    print(f\"Row count: {result['row_count']}\")\n    print(f\"Columns: {[col['name'] for col in result['columns']]}\")\n    print(\"\\nData:\")\n    # Show ALL rows\n    for i, row in enumerate(result['data']):\n        print(f\"Row {i+1}: {row}\")\n        \nexcept Exception as e:\n    print(f\"Query failed: {e}\")","display_name":"Python Code","advanced":false,"input_types":["Message"],"dynamic":false,"info":"The Python code to execute. Only modules specified in Global Imports can be used.","title_case":false,"type":"code","_input_type":"CodeInput","load_from_db":false},"refresh_token":{"load_from_db":true,"required":false,"placeholder":"","show":true,"name":"refresh_token","value":"AIE19_REFRESH_TOKEN_0113","display_name":"Refresh Token","advanced":false,"input_types":[],"dynamic":false,"info":"Refresh token for Presto authentication","title_case":false,"password":true,"type":"str","_input_type":"SecretStrInput"},"secret_token":{"load_from_db":true,"required":false,"placeholder":"","show":true,"name":"secret_token","value":"AIE19_OIDC_CLIENT_SECRET","display_name":"Secret Token","advanced":false,"input_types":[],"dynamic":false,"info":"Secret token for Presto authentication","title_case":false,"password":true,"type":"str","_input_type":"SecretStrInput"},"sql_query":{"tool_mode":false,"trace_as_metadata":true,"load_from_db":false,"list":false,"list_add_label":"Add More","required":false,"placeholder":"","show":true,"name":"sql_query","value":"","display_name":"SQL Query","advanced":false,"input_types":["Message"],"dynamic":false,"info":"SQL query to execute against Presto","title_case":false,"type":"str","_input_type":"StrInput"},"uadomain":{"tool_mode":false,"trace_as_metadata":true,"load_from_db":false,"list":false,"list_add_label":"Add More","required":false,"placeholder":"","show":true,"name":"uadomain","value":"aie19.aie.sg","display_name":"Domain for this AIE","advanced":false,"dynamic":false,"info":"Domain of this instance","title_case":false,"type":"str","_input_type":"StrInput"}},"description":"A Python code executor that lets you run Python code with specific imported modules. Remember to always use print() to see your results. Example: print(df.head())","icon":"Python","base_classes":["Data"],"display_name":"Python REPL","documentation":"","minimized":false,"custom_fields":{},"output_types":[],"pinned":false,"conditional_paths":[],"frozen":false,"outputs":[{"types":["Data"],"selected":"Data","name":"results","hidden":null,"display_name":"Results","method":"run_python_repl","value":"__UNDEFINED__","cache":true,"required_inputs":null,"allows_loop":false,"options":null,"tool_mode":true}],"field_order":["global_imports","python_code","sql_query","jwt_token","refresh_token","secret_token","uadomain","presto_catalog","presto_schema","presto_user"],"beta":false,"legacy":false,"edited":true,"metadata":{},"tool_mode":false,"lf_version":"1.4.2","official":false}},"id":"PythonREPLComponent-7Oan5","position":{"x":0,"y":0},"type":"genericNode"}],"viewport":{"x":1,"y":1,"zoom":1}},"description":"A Python code executor that lets you run Python code with specific imported modules. Remember to always use print() to see your results. Example: print(df.head())","name":"Python REPL","id":"PythonREPLComponent-7Oan5","is_component":true,"last_tested_version":"1.4.2"}