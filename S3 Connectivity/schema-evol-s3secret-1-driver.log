++ id -u
+ myuid=185
++ id -g
+ mygid=0
+ set +e
++ getent passwd 185
+ uidentry=
+ set -e
+ '[' -z '' ']'
+ '[' -w /etc/passwd ']'
+ echo '185:x:185:0:anonymous uid:/opt/spark:/bin/false'
+ '[' -z /opt/java/openjdk ']'
+ SPARK_CLASSPATH=':/opt/spark/jars/*'
+ env
+ grep SPARK_JAVA_OPT_
+ sort -t_ -k4 -n
+ sed 's/[^=]*=\(.*\)/\1/g'
++ command -v readarray
+ '[' readarray ']'
+ readarray -t SPARK_EXECUTOR_JAVA_OPTS
+ '[' -n '' ']'
+ '[' -z ']'
+ '[' -z ']'
+ '[' -n '' ']'
+ '[' -z ']'
+ '[' -z x ']'
+ SPARK_CLASSPATH='/opt/spark/conf::/opt/spark/jars/*'
+ SPARK_CLASSPATH='/opt/spark/conf::/opt/spark/jars/*:/opt/spark/work-dir'
+ case "$1" in
+ shift 1
+ CMD=("$SPARK_HOME/bin/spark-submit" --conf "spark.driver.bindAddress=$SPARK_DRIVER_BIND_ADDRESS" --conf "spark.executorEnv.SPARK_DRIVER_POD_IP=$SPARK_DRIVER_BIND_ADDRESS" --deploy-mode client "$@")
+ exec /usr/bin/tini -s -- /opt/spark/bin/spark-submit --conf spark.driver.bindAddress=10.224.165.217 --conf spark.executorEnv.SPARK_DRIVER_POD_IP=10.224.165.217 --deploy-mode client --properties-file /opt/spark/conf/spark.properties --class org.apache.spark.deploy.PythonRunner local:///mounts/shared-volume/shared/airflow-jobs/Spark_K8s_Consumer_S3iceberg-SchemaEvol.py
Files local:///mounts/shared-volume/shared/jars/spark-sql-kafka-0-10_2.12-3.5.1.jar from /mounts/shared-volume/shared/jars/spark-sql-kafka-0-10_2.12-3.5.1.jar to /opt/spark/work-dir/spark-sql-kafka-0-10_2.12-3.5.1.jar
Files local:///mounts/shared-volume/shared/jars/kafka-clients-2.6.1.jar from /mounts/shared-volume/shared/jars/kafka-clients-2.6.1.jar to /opt/spark/work-dir/kafka-clients-2.6.1.jar
Files local:///mounts/shared-volume/shared/jars/spark-token-provider-kafka-0-10_2.12-3.5.1.jar from /mounts/shared-volume/shared/jars/spark-token-provider-kafka-0-10_2.12-3.5.1.jar to /opt/spark/work-dir/spark-token-provider-kafka-0-10_2.12-3.5.1.jar
Files local:///mounts/shared-volume/shared/jars/commons-pool2-2.11.1.jar from /mounts/shared-volume/shared/jars/commons-pool2-2.11.1.jar to /opt/spark/work-dir/commons-pool2-2.11.1.jar
Files local:///mounts/shared-volume/shared/jars/iceberg-spark-runtime-3.5_2.12-1.6.0.jar from /mounts/shared-volume/shared/jars/iceberg-spark-runtime-3.5_2.12-1.6.0.jar to /opt/spark/work-dir/iceberg-spark-runtime-3.5_2.12-1.6.0.jar
24/10/11 02:14:00 WARN NativeCodeLoader: Unable to load native-hadoop library for your platform... using builtin-java classes where applicable
24/10/11 02:14:01 INFO SparkContext: Running Spark version 3.5.1
24/10/11 02:14:01 INFO SparkContext: OS info Linux, 4.18.0-513.24.1.el8_9.x86_64, amd64
24/10/11 02:14:01 INFO SparkContext: Java version 17.0.11
24/10/11 02:14:01 INFO ResourceUtils: ==============================================================
24/10/11 02:14:01 INFO ResourceUtils: No custom resources configured for spark.driver.
24/10/11 02:14:01 INFO ResourceUtils: ==============================================================
24/10/11 02:14:01 INFO SparkContext: Submitted application: HarshalSchemaEvolDemoS3
24/10/11 02:14:01 INFO ResourceProfile: Default ResourceProfile created, executor resources: Map(cores -> name: cores, amount: 1, script: , vendor: , memory -> name: memory, amount: 4096, script: , vendor: , offHeap -> name: offHeap, amount: 0, script: , vendor: ), task resources: Map(cpus -> name: cpus, amount: 1.0)
24/10/11 02:14:01 INFO ResourceProfile: Limiting resource is cpus at 1 tasks per executor
24/10/11 02:14:01 INFO ResourceProfileManager: Added ResourceProfile id: 0
24/10/11 02:14:01 INFO SecurityManager: Changing view acls to: 185,harshal
24/10/11 02:14:01 INFO SecurityManager: Changing modify acls to: 185,harshal
24/10/11 02:14:01 INFO SecurityManager: Changing view acls groups to: 
24/10/11 02:14:01 INFO SecurityManager: Changing modify acls groups to: 
24/10/11 02:14:01 INFO SecurityManager: SecurityManager: authentication disabled; ui acls disabled; users with view permissions: 185, harshal; groups with view permissions: EMPTY; users with modify permissions: 185, harshal; groups with modify permissions: EMPTY
24/10/11 02:14:02 INFO Utils: Successfully started service 'sparkDriver' on port 7078.
24/10/11 02:14:02 INFO SparkEnv: Registering MapOutputTracker
24/10/11 02:14:02 INFO SparkEnv: Registering BlockManagerMaster
24/10/11 02:14:02 INFO BlockManagerMasterEndpoint: Using org.apache.spark.storage.DefaultTopologyMapper for getting topology information
24/10/11 02:14:02 INFO BlockManagerMasterEndpoint: BlockManagerMasterEndpoint up
24/10/11 02:14:02 INFO SparkEnv: Registering BlockManagerMasterHeartbeat
24/10/11 02:14:02 INFO DiskBlockManager: Created local directory at /var/data/spark-99cf9d17-9e2d-4c3f-8248-d53ba1587675/blockmgr-0e383028-ef49-45d3-ae5e-1f91ba8c8991
24/10/11 02:14:02 INFO MemoryStore: MemoryStore started with capacity 2.1 GiB
24/10/11 02:14:02 INFO SparkEnv: Registering OutputCommitCoordinator
24/10/11 02:14:02 INFO JettyUtils: Start Jetty 0.0.0.0:4040 for SparkUI
24/10/11 02:14:02 INFO Utils: Successfully started service 'SparkUI' on port 4040.
24/10/11 02:14:02 INFO SparkContext: Added JAR local:/mounts/shared-volume/shared/jars/spark-sql-kafka-0-10_2.12-3.5.1.jar at file:/mounts/shared-volume/shared/jars/spark-sql-kafka-0-10_2.12-3.5.1.jar with timestamp 1728612841542
24/10/11 02:14:02 INFO SparkContext: Added JAR local:/mounts/shared-volume/shared/jars/kafka-clients-2.6.1.jar at file:/mounts/shared-volume/shared/jars/kafka-clients-2.6.1.jar with timestamp 1728612841542
24/10/11 02:14:02 INFO SparkContext: Added JAR local:/mounts/shared-volume/shared/jars/spark-token-provider-kafka-0-10_2.12-3.5.1.jar at file:/mounts/shared-volume/shared/jars/spark-token-provider-kafka-0-10_2.12-3.5.1.jar with timestamp 1728612841542
24/10/11 02:14:02 INFO SparkContext: Added JAR local:/mounts/shared-volume/shared/jars/commons-pool2-2.11.1.jar at file:/mounts/shared-volume/shared/jars/commons-pool2-2.11.1.jar with timestamp 1728612841542
24/10/11 02:14:02 INFO SparkContext: Added JAR local:/mounts/shared-volume/shared/jars/iceberg-spark-runtime-3.5_2.12-1.6.0.jar at file:/mounts/shared-volume/shared/jars/iceberg-spark-runtime-3.5_2.12-1.6.0.jar with timestamp 1728612841542
24/10/11 02:14:02 INFO SparkKubernetesClientFactory: Auto-configuring K8S client using current context from users K8S config file
24/10/11 02:14:03 INFO ExecutorPodsAllocator: Going to request 1 executors from Kubernetes for ResourceProfile Id: 0, target: 1, known: 0, sharedSlotFromPendingPods: 2147483647.
24/10/11 02:14:03 INFO ExecutorPodsAllocator: Found 0 reusable PVCs from 0 PVCs
24/10/11 02:14:03 INFO BasicExecutorFeatureStep: Decommissioning not enabled, skipping shutdown script
24/10/11 02:14:03 INFO Utils: Successfully started service 'org.apache.spark.network.netty.NettyBlockTransferService' on port 7079.
24/10/11 02:14:03 INFO NettyBlockTransferService: Server created on schema-evol-s3secret-1-86496392795a6174-driver-svc.harshal-5f31cc28.svc 10.224.165.217:7079
24/10/11 02:14:03 INFO BlockManager: Using org.apache.spark.storage.RandomBlockReplicationPolicy for block replication policy
24/10/11 02:14:03 INFO BlockManagerMaster: Registering BlockManager BlockManagerId(driver, schema-evol-s3secret-1-86496392795a6174-driver-svc.harshal-5f31cc28.svc, 7079, None)
24/10/11 02:14:03 INFO BlockManagerMasterEndpoint: Registering block manager schema-evol-s3secret-1-86496392795a6174-driver-svc.harshal-5f31cc28.svc:7079 with 2.1 GiB RAM, BlockManagerId(driver, schema-evol-s3secret-1-86496392795a6174-driver-svc.harshal-5f31cc28.svc, 7079, None)
24/10/11 02:14:04 INFO BlockManagerMaster: Registered BlockManager BlockManagerId(driver, schema-evol-s3secret-1-86496392795a6174-driver-svc.harshal-5f31cc28.svc, 7079, None)
24/10/11 02:14:04 INFO BlockManager: Initialized BlockManager: BlockManagerId(driver, schema-evol-s3secret-1-86496392795a6174-driver-svc.harshal-5f31cc28.svc, 7079, None)
24/10/11 02:14:04 INFO SingleEventLogFileWriter: Logging events to file:/opt/mapr/spark/sparkhs-eventlog-storage/spark-0f3775059e4043129576cf2a2cefd4a5.inprogress
24/10/11 02:14:14 INFO KubernetesClusterSchedulerBackend$KubernetesDriverEndpoint: No executor found for 10.224.165.169:54164
24/10/11 02:14:15 INFO KubernetesClusterSchedulerBackend$KubernetesDriverEndpoint: Registered executor NettyRpcEndpointRef(spark-client://Executor) (10.224.165.169:54174) with ID 1,  ResourceProfileId 0
24/10/11 02:14:15 INFO KubernetesClusterSchedulerBackend: SchedulerBackend is ready for scheduling beginning after reached minRegisteredResourcesRatio: 0.8
24/10/11 02:14:15 INFO BlockManagerMasterEndpoint: Registering block manager 10.224.165.169:42999 with 2.1 GiB RAM, BlockManagerId(1, 10.224.165.169, 42999, None)
--------------------
--------------------
--------------------
--- Check and create empty table local.default.kafka_ingest3 if not exists
CREATE OR REPLACE TABLE local.default.kafka_ingest3 As Select * from local.default.kafka_ingest5 limit 300
++
||
++
++

--- List contents to check table local.default.kafka_ingest3
select * from local.default.kafka_ingest3 limit 10
+-----+--------------------+--------------------+------+
|   id|                name|             address|amount|
+-----+--------------------+--------------------+------+
|64137|         Dustin Rich|9956 Nicholas Pra...|873737|
|72614|          Seth Cooke|4087 Kenneth Vall...| 56174|
|33598|       Linda Gilbert|USS Garcia\nFPO A...|486316|
|75619|       Gregory Payne|635 Jones River S...|431140|
|13122|    Jacqueline Allen|5990 Blair Park S...|684473|
|99059|   Tamara Montgomery|002 Zachary Well ...| 92321|
|58934|Christopher Thompson|6090 Matthew Fore...|862928|
| 6339|        Derek Kelley|8120 Kyle Tunnel ...|368548|
|26778|          Edgar Kidd|7515 Long Springs...|272445|
|18444|       Andrea Henson|19150 Mark Knolls...|777686|
+-----+--------------------+--------------------+------+

--- Alter schema and add a columnn in local.default.kafka_ingest3
ALTER TABLE local.default.kafka_ingest3 ADD COLUMN selcol VARCHAR(10)
++
||
++
++

--- Alter schema and add a columnn in local.default.kafka_ingest3
select * from local.default.kafka_ingest3 limit 10
+-----+--------------------+--------------------+------+------+
|   id|                name|             address|amount|selcol|
+-----+--------------------+--------------------+------+------+
|64137|         Dustin Rich|9956 Nicholas Pra...|873737|  NULL|
|72614|          Seth Cooke|4087 Kenneth Vall...| 56174|  NULL|
|33598|       Linda Gilbert|USS Garcia\nFPO A...|486316|  NULL|
|75619|       Gregory Payne|635 Jones River S...|431140|  NULL|
|13122|    Jacqueline Allen|5990 Blair Park S...|684473|  NULL|
|99059|   Tamara Montgomery|002 Zachary Well ...| 92321|  NULL|
|58934|Christopher Thompson|6090 Matthew Fore...|862928|  NULL|
| 6339|        Derek Kelley|8120 Kyle Tunnel ...|368548|  NULL|
|26778|          Edgar Kidd|7515 Long Springs...|272445|  NULL|
|18444|       Andrea Henson|19150 Mark Knolls...|777686|  NULL|
+-----+--------------------+--------------------+------+------+

--- Alter schema and modify columnn name in local.default.kafka_ingest3
ALTER TABLE local.default.kafka_ingest3 RENAME COLUMN selcol to highval
++
||
++
++

--- Alter schema and modify columnn name in local.default.kafka_ingest3
select * from local.default.kafka_ingest3 limit 10
+-----+--------------------+--------------------+------+-------+
|   id|                name|             address|amount|highval|
+-----+--------------------+--------------------+------+-------+
|64137|         Dustin Rich|9956 Nicholas Pra...|873737|   NULL|
|72614|          Seth Cooke|4087 Kenneth Vall...| 56174|   NULL|
|33598|       Linda Gilbert|USS Garcia\nFPO A...|486316|   NULL|
|75619|       Gregory Payne|635 Jones River S...|431140|   NULL|
|13122|    Jacqueline Allen|5990 Blair Park S...|684473|   NULL|
|99059|   Tamara Montgomery|002 Zachary Well ...| 92321|   NULL|
|58934|Christopher Thompson|6090 Matthew Fore...|862928|   NULL|
| 6339|        Derek Kelley|8120 Kyle Tunnel ...|368548|   NULL|
|26778|          Edgar Kidd|7515 Long Springs...|272445|   NULL|
|18444|       Andrea Henson|19150 Mark Knolls...|777686|   NULL|
+-----+--------------------+--------------------+------+-------+

--- Update added column in local.default.kafka_ingest3 to identify 400k or more in amount
UPDATE local.default.kafka_ingest3 SET highval = 'Y' WHERE amount > 400000
++
||
++
++

--- Update added column in local.default.kafka_ingest3 to identify 400k or more in amount
select * from local.default.kafka_ingest3 limit 10
+-----+--------------------+--------------------+------+-------+
|   id|                name|             address|amount|highval|
+-----+--------------------+--------------------+------+-------+
|64137|         Dustin Rich|9956 Nicholas Pra...|873737|      Y|
|72614|          Seth Cooke|4087 Kenneth Vall...| 56174|   NULL|
|33598|       Linda Gilbert|USS Garcia\nFPO A...|486316|      Y|
|75619|       Gregory Payne|635 Jones River S...|431140|      Y|
|13122|    Jacqueline Allen|5990 Blair Park S...|684473|      Y|
|99059|   Tamara Montgomery|002 Zachary Well ...| 92321|   NULL|
|58934|Christopher Thompson|6090 Matthew Fore...|862928|      Y|
| 6339|        Derek Kelley|8120 Kyle Tunnel ...|368548|   NULL|
|26778|          Edgar Kidd|7515 Long Springs...|272445|   NULL|
|18444|       Andrea Henson|19150 Mark Knolls...|777686|      Y|
+-----+--------------------+--------------------+------+-------+

--- Use added column in local.default.kafka_ingest3 to list out 400k or more in amount clients
select * from local.default.kafka_ingest3 WHERE highval = 'Y'
+-----+--------------------+--------------------+------+-------+
|   id|                name|             address|amount|highval|
+-----+--------------------+--------------------+------+-------+
|64137|         Dustin Rich|9956 Nicholas Pra...|873737|      Y|
|33598|       Linda Gilbert|USS Garcia\nFPO A...|486316|      Y|
|75619|       Gregory Payne|635 Jones River S...|431140|      Y|
|13122|    Jacqueline Allen|5990 Blair Park S...|684473|      Y|
|58934|Christopher Thompson|6090 Matthew Fore...|862928|      Y|
|18444|       Andrea Henson|19150 Mark Knolls...|777686|      Y|
|22881|        Laura Taylor|197 Jorge Pine Ap...|427515|      Y|
|18636|   Christopher White|7042 Lucas Freewa...|588851|      Y|
|83946|        Jacob Phelps|062 Hayes Cove Su...|726606|      Y|
|55536|     Tiffany Stewart|76866 Catherine S...|706646|      Y|
| 6694|        Michelle May|275 Hector Port\n...|762485|      Y|
|95513|      Andres Pearson|191 Diana Orchard...|826370|      Y|
|49022|         Aaron Russo|613 Cowan Extensi...|812542|      Y|
|27030|      Robert Carroll|25894 Shannon Pik...|696476|      Y|
| 2920|       Crystal Petty|7866 Ramirez Isla...|459429|      Y|
|  424|           Alan Gill|8774 Karla River ...|651362|      Y|
|90379|      Samuel Mcguire|3530 Gaines Roads...|929239|      Y|
|77528|        Shawn Nguyen|USNV Smith\nFPO A...|459279|      Y|
|  840|   Christopher James|2102 Angelica Vie...|922995|      Y|
|10484|       Craig Aguilar|9162 Brandi Lake ...|466008|      Y|
+-----+--------------------+--------------------+------+-------+
only showing top 20 rows

 ---- end of Iceberg Schema Evolution ----
--------------------
--------------------
--------------------
